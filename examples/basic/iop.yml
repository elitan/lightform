name: basic

ssh:
  username: iop

# Unified services model - everything is a service!
# Services with 'proxy' config get zero-downtime deployment automatically
# Infrastructure services get stop-start deployment
services:
  # HTTP services (get zero-downtime blue-green deployment)
  web1:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - EXAMPLE_VAR
    server: 157.180.47.213
    replicas: 1
    environment:
      plain:
        - EXAMPLE_VAR=web1
      secret:
        - SECRET_VAR
        - POSTGRES_PASSWORD
    proxy:           # This triggers zero-downtime deployment
      app_port: 3000
    health_check:
      path: /up

  web2:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - EXAMPLE_VAR
    server: 157.180.47.213
    replicas: 1
    environment:
      plain:
        - EXAMPLE_VAR=web2
      secret:
        - SECRET_VAR
        - POSTGRES_PASSWORD  
    proxy:           # This triggers zero-downtime deployment
      app_port: 3000
    health_check:
      path: /up

  # Infrastructure services (get stop-start deployment)
  db:
    image: postgres:17
    server: 157.180.47.213
    ports:
      - "5433:5432"  # Port mapping indicates infrastructure service
    environment:
      plain:
        - POSTGRES_USER=postgres
        - POSTGRES_DB=postgres
      secret:
        - POSTGRES_PASSWORD
    volumes:
      - ./pgdata:/var/lib/postgresql/data
